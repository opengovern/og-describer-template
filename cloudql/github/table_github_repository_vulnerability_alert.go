package github

import (
	opengovernance "github.com/opengovern/og-describer-template/discovery/pkg/es"
	"github.com/turbot/steampipe-plugin-sdk/v5/grpc/proto"
	"github.com/turbot/steampipe-plugin-sdk/v5/plugin"
	"github.com/turbot/steampipe-plugin-sdk/v5/plugin/transform"
)

func tableGitHubRepositoryVulnerabilityAlert() *plugin.Table {
	return &plugin.Table{
		Name:        "github_repository_vulnerability_alert",
		Description: "Vulnerability Alerts from a repository.",
		List: &plugin.ListConfig{
			Hydrate: opengovernance.ListRepoVulnerabilityAlert,
		},
		Columns: commonColumns(gitHubRepositoryVulnerabilityAlertColumns()),
	}
}

func gitHubRepositoryVulnerabilityAlertColumns() []*plugin.Column {
	return []*plugin.Column{
		{Name: "repository_full_name", Type: proto.ColumnType_STRING,
			Description: "The full name of the repository, including the owner and repo name.",
			Transform:   transform.FromField("Description.RepositoryFullName")},
		{Name: "number", Type: proto.ColumnType_INT,
			Transform:   transform.FromField("Description.Number"),
			Description: "Number of vulnerability alert."},
		{Name: "node_id", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.NodeID"),
			Description: "The node id of the vulnerability alert."},
		{Name: "auto_dismissed_at", Type: proto.ColumnType_TIMESTAMP,
			Transform:   transform.FromField("Description.AutoDismissedAt").NullIfZero().Transform(convertTimestamp),
			Description: "Timestamp at which the vulnerability alert was automatically dismissed."},
		{Name: "created_at", Type: proto.ColumnType_TIMESTAMP,
			Transform:   transform.FromField("Description.CreatedAt").NullIfZero().Transform(convertTimestamp),
			Description: "Timestamp when the vulnerability alert was created."},
		{Name: "dependency_scope", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.DependencyScope"),
			Description: "The dependency scope of the vulnerability alert, will be RUNTIME or DEVELOPMENT."},
		{Name: "dismiss_comment", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.DismissComment"),
			Description: "Comment on the dismissal of the vulnerability alert."},
		{Name: "dismiss_reason", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.DismissReason"),
			Description: "Reason for the dismissal of the vulnerability alert."},
		{Name: "dismissed_at", Type: proto.ColumnType_TIMESTAMP,
			Transform:   transform.FromField("Description.DismissedAt").NullIfZero().Transform(convertTimestamp),
			Description: "Timestamp at which the vulnerability alert was dismissed."},
		{Name: "dismisser", Type: proto.ColumnType_JSON,
			Transform:   transform.FromField("Description.Dismisser"),
			Description: "The user whom dismissed the vulnerability alert."},
		{Name: "fixed_at", Type: proto.ColumnType_TIMESTAMP,
			Transform:   transform.FromField("Description.FixedAt").NullIfZero().Transform(convertTimestamp),
			Description: "Timestamp when the vulnerability alert was marked as fixed."},
		{Name: "state", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.State"),
			Description: "State of the vulnerability alert, will be 'OPEN', 'FIXED' or 'DISMISSED'."},
		{Name: "security_advisory", Type: proto.ColumnType_JSON,
			Transform:   transform.FromField("Description.SecurityAdvisory"),
			Description: "The security advisory associated with the vulnerability alert."},
		{Name: "security_vulnerability", Type: proto.ColumnType_JSON,
			Transform:   transform.FromField("Description.SecurityVulnerability"),
			Description: "The vulnerability associated with the vulnerability alert."},
		{Name: "vulnerable_manifest_filename", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.VulnerableManifestFilename"),
			Description: "Filename of the vulnerable manifest."},
		{Name: "vulnerable_manifest_path", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.VulnerableManifestPath"),
			Description: "Path of the vulnerable manifest."},
		{Name: "vulnerable_requirements", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.VulnerableRequirements"),
			Description: "Vulnerable requirements from the manifest."},
		{Name: "severity", Type: proto.ColumnType_STRING,
			Transform:   transform.FromField("Description.Severity"),
			Description: "Severity of the vulnerability."},
		{Name: "cvss_score", Type: proto.ColumnType_DOUBLE,
			Transform:   transform.FromField("Description.CvssScore"),
			Description: "The CVSS score of the advisory associated with the vulnerability alert."},
	}
}
